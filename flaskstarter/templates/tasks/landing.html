{% from "macros/_form.html" import render_form %} {% set page_title = 'Home' %}
{% extends 'layouts/base.html' %} {% block body %} {% include
'layouts/banner.html' %}

<div class="container">
  <div class="row justify-content-center">
    <div class="intro-h">Dataset Distribution</div>
    <div id="map" style="width: 100vw; height: 100vh"></div>

    <table id="distro_data" class="table table-striped">
      <thead>
        <tr>
          <th>Id</th>
          <th>Dataset</th>
          <th>Tissue</th>
          <th>Protocol</th>
          <th>Technology</th>
          <th>Number of samples</th>
          <th>Number of cells</th>
          <th>Country</th>
          <th>Published_Date</th>
          <th>Journal</th>
          <th>Link</th>
        </tr>
      </thead>
      <tbody>
      {% for item in fdataset %}
      <tr>
        <td>{{item.id}}</td>
        <td>{{item.meta_dataset}}</td>
        <td>{{item.meta_tissue}}</td>
        <td>{{item.meta_protocol}}</td>
        <td>{{item.meta_technology}}</td>
        <td>{{item.number_of_samples}}</td>
        <td>{{item.number_of_cells}}</td>
        <td>{{item.Country}}</td>
        <td>{{item.Published_Date}}</td>
        <td>{{item.Journal}}</td>
        <td><a href='{{url_for("tasks.table_view", main={"meta_dataset": item.meta_dataset}|tojson)}}'>Link</a></td></tr>

      {% endfor %}
      </tbody>
    </table>  


    {% for dict_item in fcelltype %}
       <h1>Key: {{dict_item._id}}</h1>
       <h2>Value: {{dict_item.count}}</h2>
    {% endfor %}

  </div>
</div>

<div class="section02">
    <div class="intro-h">Cell Type Distribution</div>
    <div id="pieChart" style="width: 100vw; height: 100vh"></div>
  </div>

</div>



<div class="section01">

  <div class="container flex-column">
    <div class="intro-h">What is the D²4H Single-cell Data Share?</div>
    <div class="intro-c">
      The D²4H Single-cell Data Share stores and provides over 3.2 million
      single-cell data by 21 published single-cell sequencing datasets. Anyone
      can explore the insights from our analysis and download the data provided
      here for further analysis.
    </div>
    <div class="d-flex justify-content-center">
      <table class="intro-tb">
        <tr>
          <td>
            <img
              src="{{url_for('static', filename='newspaper.png')}}"
              width="140"
              height="140"
            />
          </td>
          <td></td>
          <td>
            <img
              src="{{url_for('static', filename='explore.png')}}"
              width="140"
              height="140"
            />
          </td>
          <td></td>
          <td>
            <img
              src="{{url_for('static', filename='folder.png')}}"
              width="140"
              height="140"
            />
          </td>
        </tr>
        <tr>
          <td>
            <p>Insight</p>
          </td>
          <td></td>
          <td>
            <p>Expore data</p>
          </td>
          <td></td>
          <td>
            <p>Download and Citation</p>
          </td>
        </tr>
      </table>
    </div>
  </div>
</div>

<div class="section02">
  <div class="container flex-column">
    <div class="intro-h">D²4H Single-cell Data Share Life Cycle</div>
    <div class="intro-c">
      The D²4H Single-cell Data Share provides a platform for sharing
      single-cell data. We welcome anyone to contribute on our data sharing
      coummuniaty.
    </div>
    <div class="d-flex justify-content-center">
      <table class="intro-tb">
        <tr>
          <td>
            <img
              src="{{url_for('static', filename='folder-3.png')}}"
              width="140"
              height="140"
            />
          </td>
          <td>
            <img
              src="{{url_for('static', filename='Pointer.png')}}"
              width="95"
              height="95"
            />
          </td>
          <td>
            <img
              src="{{url_for('static', filename='microscope.png')}}"
              width="140"
              height="140"
            />
          </td>
          <td>
            <img
              src="{{url_for('static', filename='Pointer.png')}}"
              width="95"
              height="95"
            />
          </td>
          <td>
            <img
              src="{{url_for('static', filename='folder-2.png')}}"
              width="140"
              height="140"
            />
          </td>
        </tr>
        <tr>
          <td>
            <p>Users contribute single-cell data</p>
          </td>
          <td></td>
          <td>
            <p>D²4H processes the data</p>
          </td>
          <td></td>
          <td>
            <p>Users can find suitable data to download</p>
          </td>
        </tr>
      </table>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}

<script src="https://www.amcharts.com/lib/4/core.js"></script>
<script src="https://www.amcharts.com/lib/4/maps.js"></script>
<script src="https://cdn.amcharts.com/lib/4/geodata/worldLow.js"></script>
<script src="https://www.amcharts.com/lib/4/themes/animated.js"></script>
<script src="https://cdn.amcharts.com/lib/4/charts.js"></script>

<script>

   // Create map instance
   const chart = am4core.create("map", am4maps.MapChart);

   // Set map definition
   chart.geodata = am4geodata_worldLow;

   // Set projection
   chart.projection = new am4maps.projections.Miller();

   chart.deltaLongitude = -160;

   const title = chart.titles.create();

   title.text = "Dataset distribution by Region";
   title.fontFamily = "Inter";
   title.fontSize = 25;
   title.fill = am4core.color("#275950");
   title.align = "left";
   title.paddingTop = 40;
   title.paddingLeft = 30;

   // Create map polygon series
   const polygonSeries = chart.series.push(new am4maps.MapPolygonSeries());

   // Exclude Antartica
   polygonSeries.exclude = ["AQ"];

   // Make map load polygon (like country names) data from GeoJSON
   polygonSeries.useGeodata = true;

   // Configure series
   const polygonTemplate = polygonSeries.mapPolygons.template;

   polygonTemplate.tooltipHTML = '<b>{name}: {value}</b><br><a href="http://147.8.194.29:5000/tasks/table_view?main=%7B%22meta_dataset%22%3A+%7B%22$in%22%3A+%5B{dataset}5D%7D%7D">Explore</a>';
   polygonTemplate.fill = am4core.color("rgba(110, 166, 157, 0.5)");
   //polygonTemplate.tooltipText = '<b>{name}: {value}</b>';


   // Create hover state and set alternative fill color
   const hs = polygonTemplate.states.create("hover");
   hs.properties.fill = am4core.color("#489587");

   // Set up tooltips
   polygonSeries.calculateVisualCenter = true;
   polygonTemplate.tooltipPosition = "fixed";
   polygonSeries.tooltip.label.interactionsEnabled = true;
   polygonSeries.tooltip.keepTargetHover = true;

   // heatRules
   polygonSeries.heatRules.push({
     "target": polygonSeries.mapPolygons.template,
     "property": "fill",
     "min": am4core.color("#1CC5DC"),
     "max": am4core.color("#AA2EE6"),
     "dataField": "value",
   });

   // value
     const data = {{ data|tojson }}
     const objs = []

     for ( let country in data["Country Code"]) {
       let obj = {id: data["Country Code"][country], value: 1, dataset: ""};
       if (objs.length > 0) {
        for (let j = 0; j < objs.length; j++) {
          if (objs[j].id == obj.id) {
            let k = objs[j].value;
            objs[j].value = k + 1;
            break;
          } else if (j == objs.length - 1) {
            console.log(data["Country Code"][country])
            if (data["Country Code"][country] == "US") {
              obj.dataset = "%22COMBAT_2022%22,+%22Stephenson_2021%22%"
            } else if (data["Country Code"][country] == "GB") {
              obj.dataset = "%22Lee_2020%22,+%22Liu_2021%22%"
            } else if (data["Country Code"][country] == "DE") {
              obj.dataset = ""
            } else if (data["Country Code"][country] == "IL") {
              obj.dataset = ""
            } else if (data["Country Code"][country] == "KR") {
              obj.dataset = ""
            } else if (data["Country Code"][country] == "CN") {
              obj.dataset = ""
            } else if (data["Country Code"][country] == "NL") {
              obj.dataset = ""
            } else if (data["Country Code"][country] == "FR") {
              obj.dataset = ""
            } else if (data["Country Code"][country] == "CA") {
              obj.dataset = ""
            }
            objs.push(obj);
            break;
          }
        }
      } else {
        console.log(data["Country Code"][country])
        if (data["Country Code"][country] == "US") {
          obj.dataset = "%22COMBAT_2022%22,+%22Stephenson_2021%22%"
        } else if (data["Country Code"][country] == "GB") {
          obj.dataset = "%22Lee_2020%22,+%22Liu_2021%22%"
        } else if (data["Country Code"][country] == "DE") {
          obj.dataset = ""
        } else if (data["Country Code"][country] == "IL") {
          obj.dataset = ""
        } else if (data["Country Code"][country] == "KR") {
          obj.dataset = ""
        } else if (data["Country Code"][country] == "CN") {
          obj.dataset = ""
        } else if (data["Country Code"][country] == "NL") {
          obj.dataset = ""
        } else if (data["Country Code"][country] == "FR") {
          obj.dataset = ""
        } else if (data["Country Code"][country] == "CA") {
          obj.dataset = ""
        }
        objs.push(obj)
      }

      

     }

   polygonSeries.data = objs;
</script>

<script>
  // Create chart instance
const pieChart = am4core.create("pieChart", am4charts.PieChart);

// Add and configure Series
var pieSeries = pieChart.series.push(new am4charts.PieSeries());
pieSeries.dataFields.value = "pieces";
pieSeries.dataFields.category = "type";
pieSeries.tooltip.label.interactionsEnabled = true;
pieSeries.tooltip.keepTargetHover = true;

// Add data

const pieData = {{ fcelltype|tojson }};
const pieObjs = []

for ( let celltype in pieData) {
  let pieObj = {"type": pieData[celltype]._id, "pieces": pieData[celltype].count}
  pieObjs.push(pieObj)
  pieSeries.slices.template.tooltipHTML = '<b>{type}: {pieces}</b><br><a href="http://0.0.0.0:5000/tasks/table_view?main=%7B%22level2%22%3A+%22{type}%22%7D">Explore</a>';

// https://en.wikipedia.org/wiki/{name.urlEncode()}
}

  pieChart.data=pieObjs;
  
//  pieChart.data=[
//  {% for dict_item in fcelltype|tojson %}
//  {
//      "type" : {{dict_item._id}},
//      "pieces" : {{dict_item.count}}

//  },
//  {% endfor %}
//  ];

$(document).ready( function () {
    $('#distro_data').DataTable();
} );

</script>



{% endblock %}